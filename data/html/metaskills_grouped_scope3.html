<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>metaskills_grouped_scope3</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<p>we use the <code>:email_present</code> scope to refine the group down.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">class</span> <span class="dt">Employee</span> &lt; <span class="dt">ActiveRecord</span>::<span class="dt">Base</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2">  has_many <span class="st">:reports</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3">  grouped_scope <span class="st">:reports</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4">  scope <span class="st">:email_present</span>, where(<span class="st">&quot;email IS NOT NULL&quot;</span>)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="kw">end</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="ot">@employee_one</span> = <span class="dt">Employee</span>.create <span class="st">:group_id</span> =&gt; <span class="dv">5</span>, <span class="st">:name</span> =&gt; <span class="st">&#39;Ken&#39;</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="ot">@employee_two</span> = <span class="dt">Employee</span>.create <span class="st">:group_id</span> =&gt; <span class="dv">5</span>, <span class="st">:name</span> =&gt; <span class="st">&#39;MetaSkills&#39;</span>, <span class="st">:email</span> =&gt; <span class="st">&#39;ken@metaskills.net&#39;</span></a>
<a class="sourceLine" id="cb1-9" data-line-number="9"></a>
<a class="sourceLine" id="cb1-10" data-line-number="10"><span class="co"># Only one employee is returned now.</span></a>
<a class="sourceLine" id="cb1-11" data-line-number="11"><span class="ot">@employee_one</span>.group.email_present <span class="co"># =&gt; [#&lt;Employee id: 1, group_id: 5, name: &#39;MetaSkills&#39;, email: &#39;ken@metaskills.net&#39;]</span></a></code></pre></div>
<p>We always use raw SQL to get the group ids vs. mapping them to an array and using those in scopes. This means that large groups can avoid pushing down hundreds of keys in SQL form. So given an employee with a <code>group_id</code> of <code>43</code> and calling <code>@employee.group.reports</code>, you would get something similar to the following SQL.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">SELECT</span> <span class="ot">&quot;reports&quot;</span>.* </a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="kw">FROM</span> <span class="ot">&quot;reports&quot;</span>  </a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="kw">WHERE</span> <span class="ot">&quot;reports&quot;</span>.<span class="ot">&quot;employee_id&quot;</span> <span class="kw">IN</span> (</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">  <span class="kw">SELECT</span> <span class="ot">&quot;employees&quot;</span>.<span class="ot">&quot;id&quot;</span> </a>
<a class="sourceLine" id="cb2-5" data-line-number="5">  <span class="kw">FROM</span> <span class="ot">&quot;employees&quot;</span>  </a>
<a class="sourceLine" id="cb2-6" data-line-number="6">  <span class="kw">WHERE</span> <span class="ot">&quot;employees&quot;</span>.<span class="ot">&quot;group_id&quot;</span> = <span class="dv">43</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7">)</a></code></pre></div>
<p>You can pass the group scoped object as a predicate to ActiveRecord’s relation interface. In past versions, this would have treated the group object as an array of IDs. The new behavior is to return a SQL literal to be used with IN statements. So note, the following would generate SQL similar to the one above.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="dt">Employee</span>.where(<span class="st">:group_id</span> =&gt; <span class="ot">@employee</span>.group).all</a></code></pre></div>
<p>If you need more control and you are working with the group at a lower level, you can always use the <code>#ids</code> or <code>#ids_sql</code> methods on the group.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># Returns primary key array.</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="ot">@employee</span>.group.ids <span class="co"># =&gt; [33, 58, 240]</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="co"># Returns a Arel::Nodes::SqlLiteral object.</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="ot">@employee</span>.group.ids_sql <span class="co"># =&gt; &#39;SELECT &quot;employees&quot;.&quot;id&quot; FROM &quot;employees&quot;  WHERE &quot;employees&quot;.&quot;group_id&quot; = 33&#39;</span></a></code></pre></div>
</body>
</html>
