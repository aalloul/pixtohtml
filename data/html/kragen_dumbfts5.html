<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>kragen_dumbfts5</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<p>To generate all needed skip files automatically:</p>
<pre><code>$ buildskips.py 50000 ~/mail/mailbox.idx/*</code></pre>
<p>If you want to build a single skip file manually, although I think the necessity for this is past:</p>
<pre><code>$ sparse.py 50000 ~/mail/mailbox.idx/merged-segment-serno &gt; \
                  ~/mail/mailbox.idx/.skip.index-segment-serno</code></pre>
<p>The number “50000” is a tunable parameter called “chunksize”. 50000 is a reasonable value. I used to use 200000, but 50000 gives me much better performance. 12500 gives about the same performance as 50000 (more disk, less CPU) but takes a lot longer to build the skipfiles. 50000 is the <code>chunksize</code> that <code>indexmail.py</code> uses when it initially generates skipfiles.</p>
<p>There’s a file in the index directory called <code>.indexed-up-to</code> that tells how much of the mailbox file has been indexed.</p>
<h2 id="tuning">Tuning</h2>
<p>Chunksize is the approximate number of index segment bytes to go between skip file entries. It should be in the neighborhood of the product of your disk’s access latency (seek time plus rotational latency) and its read bandwidth. So if your access latency is 8ms and your read bandwidth is 9MB/s, it should be in the neighborhood of 8 × 9000 = 72000. Making it larger will give you smaller skip files; making it smaller will give you larger skip files. If your skip files get too big, you can make skip files <code>.skip.skip.index-segment.6244.1</code> for the skip files, and so on ad infinitum. But every level of skip files costs a seek.</p>
<p>Merging all of your index segments into a single big index segment will always give you better query performance, but it takes a long time and can take a lot of disk space for the intermediate results. Trying to merge too many segments at once could in theory make the merge slower, but I think the number of segments where you have that problem is in the neighborhood of (RAM size / chunksize), so these days you should be able to merge tens of thousands of index segments at once, so that’s probably a problem of the past.</p>
<p>Probably the best merging policy is something resembling the following:</p>
<ul>
<li>Delay merging while you’re actively indexing.</li>
<li>Merge whenever some index segment and all of the smaller index segments total more than N times the size of that index segment. A</li>
</ul>
</body>
</html>
