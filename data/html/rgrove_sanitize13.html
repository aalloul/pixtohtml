<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>rgrove_sanitize13</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<div class="sourceCode" id="cb1"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb1-1" data-line-number="1">youtube_transformer = lambda <span class="kw">do</span> |env|</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">  node      = env[<span class="st">:node</span>]</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">  node_name = env[<span class="st">:node_name</span>]</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1-5" data-line-number="5">  <span class="co"># Don&#39;t continue if this node is already whitelisted or is not an element.</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6">  <span class="kw">return</span> <span class="kw">if</span> env[<span class="st">:is_whitelisted</span>] || !node.element?</a>
<a class="sourceLine" id="cb1-7" data-line-number="7"></a>
<a class="sourceLine" id="cb1-8" data-line-number="8">  <span class="co"># Don&#39;t continue unless the node is an iframe.</span></a>
<a class="sourceLine" id="cb1-9" data-line-number="9">  <span class="kw">return</span> <span class="kw">unless</span> node_name == <span class="st">&#39;iframe&#39;</span></a>
<a class="sourceLine" id="cb1-10" data-line-number="10"></a>
<a class="sourceLine" id="cb1-11" data-line-number="11">  <span class="co"># Verify that the video URL is actually a valid YouTube video URL.</span></a>
<a class="sourceLine" id="cb1-12" data-line-number="12">  <span class="kw">return</span> <span class="kw">unless</span> node[<span class="st">&#39;src&#39;</span>] =~<span class="ot"> %r|\A(?:https?:)?//(?:www\.)?youtube(?:-nocookie)?\.com/|</span></a>
<a class="sourceLine" id="cb1-13" data-line-number="13"></a>
<a class="sourceLine" id="cb1-14" data-line-number="14"><span class="ot">  # We&#39;re now certain that this is a YouTube embed, but we still need to run</span></a>
<a class="sourceLine" id="cb1-15" data-line-number="15"><span class="ot">  # it through a special Sanitize step to ensure that no unwanted elements or</span></a>
<a class="sourceLine" id="cb1-16" data-line-number="16"><span class="ot">  # attributes that don&#39;t belong in a YouTube embed can sneak in.</span></a>
<a class="sourceLine" id="cb1-17" data-line-number="17"><span class="ot">  Sanitize.node!(node, {</span></a>
<a class="sourceLine" id="cb1-18" data-line-number="18"><span class="ot">    :elements =&gt; %w[iframe],</span></a>
<a class="sourceLine" id="cb1-19" data-line-number="19"></a>
<a class="sourceLine" id="cb1-20" data-line-number="20"><span class="ot">    :attributes =&gt; {</span></a>
<a class="sourceLine" id="cb1-21" data-line-number="21"><span class="ot">      &#39;iframe&#39;  =&gt; %w[allowfullscreen frameborder height src width]</span></a>
<a class="sourceLine" id="cb1-22" data-line-number="22"><span class="ot">    }</span></a>
<a class="sourceLine" id="cb1-23" data-line-number="23"><span class="ot">  })</span></a>
<a class="sourceLine" id="cb1-24" data-line-number="24"></a>
<a class="sourceLine" id="cb1-25" data-line-number="25"><span class="ot">  # Now that we&#39;re sure that this is a valid YouTube embed and that there are</span></a>
<a class="sourceLine" id="cb1-26" data-line-number="26"><span class="ot">  # no unwanted elements or attributes hidden inside it, we can tell Sanitize</span></a>
<a class="sourceLine" id="cb1-27" data-line-number="27"><span class="ot">  # to whitelist the current node.</span></a>
<a class="sourceLine" id="cb1-28" data-line-number="28"><span class="ot">  {:node_whitelist =&gt; [node]}</span></a>
<a class="sourceLine" id="cb1-29" data-line-number="29"><span class="ot">end</span></a>
<a class="sourceLine" id="cb1-30" data-line-number="30"></a>
<a class="sourceLine" id="cb1-31" data-line-number="31"><span class="ot">html = %[</span></a>
<a class="sourceLine" id="cb1-32" data-line-number="32"><span class="ot">&lt;iframe width=&quot;420&quot; height=&quot;315&quot; src=&quot;//www.youtube.com/embed/dQw4w9WgXcQ&quot;</span></a>
<a class="sourceLine" id="cb1-33" data-line-number="33"><span class="ot">    frameborder=&quot;0&quot; allowfullscreen&gt;&lt;/iframe&gt;</span></a>
<a class="sourceLine" id="cb1-34" data-line-number="34"><span class="ot">]</span></a>
<a class="sourceLine" id="cb1-35" data-line-number="35"></a>
<a class="sourceLine" id="cb1-36" data-line-number="36"><span class="ot">Sanitize.fragment(html, :transformers =&gt; youtube_transformer)</span></a>
<a class="sourceLine" id="cb1-37" data-line-number="37"><span class="ot"># =&gt; &#39;&lt;iframe width=&quot;420&quot; height=&quot;315&quot; src=&quot;//www.youtube.com/embed/dQw4w9WgXcQ&quot; frameborder=&quot;0&quot; allowfullscreen=&quot;&quot;&gt;&lt;/iframe&gt;&#39;</span></a></code></pre></div>
<h2 id="license">License</h2>
<p>Copyright (c) 2015 Ryan Grove (ryan@wonko.com)</p>
<p>Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the ‘Software’), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of</p>
</body>
</html>
