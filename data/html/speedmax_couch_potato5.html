<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>speedmax_couch_potato5</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<p>When querying this view you will get the raw data returned by CouchDB which looks something like this: {‘total_entries’: 2, ‘rows’: [{‘value’: ‘alex’, ‘key’: ‘2009-01-03 00:02:34 +000’, ‘id’: ‘75976rgi7546gi02a’}]}</p>
<p>To process this raw data you can also pass in a results filter:</p>
<pre><code>class User
  view :all, :map =&gt; &quot;function(doc) { emit(doc.created_at, doc.name)}&quot;, :type =&gt; :raw, :results_filter =&gt; lambda {|results| results[&#39;rows&#39;].map{|row| row[&#39;value&#39;]}}
end</code></pre>
<p>In this case querying the view would only return the emitted value for each row.</p>
<h4 id="associations">Associations</h4>
<p>Not supported. Not sure if they ever will be. You can implement those yourself using views and custom methods on your models.</p>
<h4 id="callbacks">Callbacks</h4>
<p>Couch Potato supports the usual lifecycle callbacks known from ActiveRecord:</p>
<pre><code>class User
  include CouchPotato::Persistence

  before_create :do_something_before_create
  before_update {|user, db| user.do_something_on_update}
end</code></pre>
<p>This will call the method do_something_before_create before creating an object and run the given lambda before updating one. Lambda callbacks get passed the model as their first argument. Optionally if a lambda declares two arguments it also gets passed the database object. This is useful for creating other objects or querying views. Method callbacks don’t receive any arguments by default but will get passed the database if they declare an argument.</p>
<p>Supported callbacks are: :before_validation_on_create, :before_validation_on_update, :before_validation_on_save, :before_create, :after_create, :before_update, :after_update, :before_save, :after_save, :before_destroy, :after_destroy.</p>
<h4 id="testing">Testing</h4>
<p>To make testing easier and faster database logic has been put into its own class, which you can replace and stub out in whatever way you want:</p>
<pre><code>class User
  include CouchPotato::Persistence
end

# RSpec
describe &#39;save a user&#39; do
  it &#39;should save&#39; do
    couchrest_db = stub &#39;couchrest_db&#39;, 
    database = CouchPotato::Database.new couchrest_db
    user = User.new
    couchrest_db.should_receive(:save_doc).with(...)
    database.save_document user
  end
end</code></pre>
<p>By creating you own instances of CouchPotato::Database and passing them a fake CouchRest database instance you can completely disconnect your unit tests/spec from the database.</p>
</body>
</html>
