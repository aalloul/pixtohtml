<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>RISCfuture_autumn15</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<p>But what if you wanted to use that connection for other leaves too, so you named it something like “local_database”? Now, Autumn won’t be able to guess that you want to use that DB context, so you have to specify it manually:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">def</span> fortune_command(stem, sender, reply_to, msg)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">  database(<span class="st">:local_database</span>) <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3">    fortunes = <span class="dt">Fortune</span>.all</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">    <span class="kw">return</span> fortunes[rand(fortunes.size)].text</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="kw">end</span></a></code></pre></div>
<p>If that is too tedious, you can specify the database connection manually in the <code>leaves.yml</code> file:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="fu">FortuneBot:</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">  <span class="fu">class:</span><span class="at"> FortuneLeaf</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3">  <span class="fu">database:</span><span class="at"> local_database</span></a></code></pre></div>
<p>OK, now onto the second special case. Let’s go back to the case where Autumn can automatically guess your database connection name. Now, imagine you want your fortune bot to also send a fortune in response to a CTCP <code>VERSION</code> request. So, you’d implement a method like so:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">def</span> ctcp_version_request(handler, stem, sender, arguments)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">  fortune = random_fortune <span class="co"># Loads a random fortune</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3">  send_ctcp_reply stem, sender[<span class="st">:nick</span>], <span class="st">&#39;VERSION&#39;</span>, fortune.text</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="kw">end</span></a></code></pre></div>
<p>This will break – why? Because the <code>ctcp_version_request</code> method is in the realm of the {Autumn::CTCP} class, <em>not</em> the Autumn::Leaf class. (You can see this by investigating the CTCP class docs; it shows you what methods you can implement for CTCP support.) Basically, the <code>CTCP</code> class calls your method directly, giving the Autumn::Leaf class no chance to set up the database first. So to fix it, make a call to <code>database</code> first:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">def</span> ctcp_version_request(handler, stem, sender, arguments)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">  fortune = database { random_fortune }</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">  send_ctcp_reply stem, sender[<span class="st">:nick</span>], <span class="st">&#39;VERSION&#39;</span>, fortune.text</a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="kw">end</span></a></code></pre></div>
<p>This will execute those methods in the scope of the database connection guessed by Autumn::Leaf. Of course, you can manually pass in a connection name if</p>
</body>
</html>
