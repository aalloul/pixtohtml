<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>etnt_eopenid1</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<p>This is an implementation of OpenID version 1.1.</p>
<p>(NB: IT DOES NOT (YET) IMPLEMENT THE DUMB MODE!)</p>
<p>Requirements: at least R12B-5 it can also make use of Yaws/Mochiweb/trane if available)</p>
<p>Start Erlang as:</p>
<pre><code>erl -pa ./ebin -pa ~/svn/mochiweb-read-only/ebin -s eopenid</code></pre>
<p>NB: MAKE SURE YOU ACTUALLY START eopenid AS ABOVE, OR CALL application:start(eopenid) ELSEWHERE IN YOUR STARTUP CODE!!</p>
<p>At the moment you can try it out as shown below (nb: change the values according to your setup). Also, this example is using some Nitrogen code (wf.erl):</p>
<pre><code>[ClaimedId] = wf:q(claimed_id),
Dict0 = eopenid_lib:foldf(
          [eopenid_lib:in(&quot;openid.return_to&quot;, 
                          &quot;http://www.tornkvist.org:8002/web/openid&quot;),
           eopenid_lib:in(&quot;openid.trust_root&quot;, 
                          &quot;http://www.tornkvist.org:8002&quot;)
          ], eopenid_lib:new()),
{ok,Dict1} = eopenid_v1:discover(ClaimedId, Dict0),
{ok,Dict2} = eopenid_v1:associate(Dict1),
{ok, Url}  = eopenid_v1:checkid_setup(Dict2).
wf:session(eopenid_dict, Dict2),
wf:redirect(Url)</code></pre>
<p>The above will perform DISCOVER, ASSOCIATE, CHECKID_SETUP and return the Url to be used for redirecting the client. Note that an associate request only is made the first time eopenid see a new Provider (the Association is cached the very first time). The Nitrogen framework will in this example send a redirect to the client, who will login to its Provider and (again) will be redirected, this time to the <em>return_to</em> address.</p>
<p>At the <em>return_to</em> address we have the following code which verifies the signed keys that the Provider sent along with the redirect in the <em>returned_to</em> Url:</p>
<pre><code>Dict = wf:session(eopenid_dict),
RawPath = wf_platform:get_raw_path(),
%% assertion
true = eopenid_v1:verify_signed_keys(RawPath, Dict),
ClaimedId = eopenid_lib:out(&quot;openid.claimed_id&quot;, Dict),
wf:user(ClaimedId),
wf:redirect(&quot;/web/write/&quot;)</code></pre>
</body>
</html>
