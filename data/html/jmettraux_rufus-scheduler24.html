<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>jmettraux_rufus-scheduler24</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<p>If the lockfile mechanism here is not sufficient, you can plug your custom mechanism. It’s explained in <a href="#advanced-lock-schemes">advanced lock schemes</a> below.</p>
<h3 id="scheduler_lock">:scheduler_lock</h3>
<p>(since rufus-scheduler 3.0.9)</p>
<p>The scheduler lock is an object that responds to <code>#lock</code> and <code>#unlock</code>. The scheduler calls <code>#lock</code> when starting up. If the answer is <code>false</code>, the scheduler stops its initialization work and won’t schedule anything.</p>
<p>Here is a sample of a scheduler lock that only lets the scheduler on host “coffee.example.com” start:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">class</span> <span class="dt">HostLock</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2">  <span class="kw">def</span> initialize(lock_name)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">    <span class="ot">@lock_name</span> = lock_name</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5">  <span class="kw">def</span> lock</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">    <span class="ot">@lock_name</span> == <span class="st">`hostname -f`</span>.strip</a>
<a class="sourceLine" id="cb1-7" data-line-number="7">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8">  <span class="kw">def</span> unlock</a>
<a class="sourceLine" id="cb1-9" data-line-number="9">    <span class="dv">true</span></a>
<a class="sourceLine" id="cb1-10" data-line-number="10">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb1-11" data-line-number="11"><span class="kw">end</span></a>
<a class="sourceLine" id="cb1-12" data-line-number="12"></a>
<a class="sourceLine" id="cb1-13" data-line-number="13">scheduler =</a>
<a class="sourceLine" id="cb1-14" data-line-number="14">  <span class="dt">Rufus</span>::<span class="dt">Scheduler</span>.new(<span class="st">:scheduler_lock</span> =&gt; <span class="dt">HostLock</span>.new(<span class="st">&#39;coffee.example.com&#39;</span>))</a></code></pre></div>
<p>By default, the scheduler_lock is an instance of <code>Rufus::Scheduler::NullLock</code>, with a <code>#lock</code> that returns true.</p>
<h3 id="trigger_lock">:trigger_lock</h3>
<p>(since rufus-scheduler 3.0.9)</p>
<p>The trigger lock in an object that responds to <code>#lock</code>. The scheduler calls that method on the job lock right before triggering any job. If the answer is false, the trigger doesn’t happen, the job is not done (at least not in this scheduler).</p>
<p>Here is a (stupid) PingLock example, it’ll only trigger if an “other host” is not responding to ping. Do not use that in production, you don’t want to fork a ping process for each trigger attempt…</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">class</span> <span class="dt">PingLock</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">  <span class="kw">def</span> initialize(other_host)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">    <span class="ot">@other_host</span> = other_host</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5">  <span class="kw">def</span> lock</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">    ! system(<span class="st">&quot;ping -c 1 </span><span class="ot">#{@other_host}</span><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="kw">end</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9"></a>
<a class="sourceLine" id="cb2-10" data-line-number="10">scheduler =</a>
<a class="sourceLine" id="cb2-11" data-line-number="11">  <span class="dt">Rufus</span>::<span class="dt">Scheduler</span>.new(<span class="st">:trigger_lock</span> =&gt; <span class="dt">PingLock</span>.new(<span class="st">&#39;main.example.com&#39;</span>))</a></code></pre></div>
</body>
</html>
