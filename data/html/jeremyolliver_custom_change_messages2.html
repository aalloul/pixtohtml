<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>jeremyolliver_custom_change_messages2</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<h1 id="detailed-example">Detailed Example</h1>
<p>The main use of this is to help clean up controller actions, such as:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">class</span> <span class="dt">ItemsController</span> &lt; <span class="dt">ApplicationController</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1-3" data-line-number="3">  <span class="kw">def</span> update</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">    <span class="ot">@item</span>.attributes = params[<span class="st">:item</span>]</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">    <span class="dt">Mailer</span>.deliver_item_update(<span class="ot">@item</span>, <span class="ot">@item</span>.change_messages.to_sentence)</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">    <span class="ot">@item</span>.save!</a>
<a class="sourceLine" id="cb1-7" data-line-number="7"></a>
<a class="sourceLine" id="cb1-8" data-line-number="8">  <span class="kw">rescue</span> <span class="dt">ActiveRecord</span>::<span class="dt">RecordInvalid</span> =&gt; e</a>
<a class="sourceLine" id="cb1-9" data-line-number="9">    flash[<span class="st">:error</span>] = e.reord.error_messages</a>
<a class="sourceLine" id="cb1-10" data-line-number="10">    redirect_to item_url(<span class="ot">@item</span>)</a>
<a class="sourceLine" id="cb1-11" data-line-number="11">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb1-12" data-line-number="12"></a>
<a class="sourceLine" id="cb1-13" data-line-number="13"><span class="kw">end</span></a></code></pre></div>
<p>In this example we use <code>attributes=</code> instead of <code>update_attributes</code> because the change_messages functionality is required to be called before you save the object, detecting what is changed from the state read from the database. For more advanced uses, you can add in <code>before_save</code> hooks to log changed details for you.</p>
<p><code>@item.change_messages.to_sentence</code> will return human readable mesages in a string format such as: =&gt; “Description has changed from ‘Nice and easy’ to ‘This task is now rather long and arduous’, User has changed from ‘Jeremy’ to ‘Guy’, and Due Date has been rescheduled from ‘09/11/2008’ to ‘10/11/2008’”</p>
<p>The messages for each attribute are also customizable, which is especially handy for dealing with belongs_to assocations. Here’s a more complicated example:</p>
<p>Use the <code>custom_message_for</code> method to customize the message for the attribute, specifying <code>:display =&gt; :name</code> will use the method/attribute :name for displaying the record that the item belongs to</p>
<p>The <code>skip_message_for</code> method can be used to prevent stop any changes to a particular attribute showing up</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">class</span> <span class="dt">Item</span> &lt; <span class="dt">ActiveRecord</span>::<span class="dt">Base</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">  belongs_to <span class="st">:person</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"></a>
<a class="sourceLine" id="cb2-4" data-line-number="4">  custom_message_for <span class="st">:person</span>, <span class="st">:display</span> =&gt; <span class="st">:username</span> <span class="co"># display the person&#39;s username instead of the id</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5">  custom_message_for <span class="st">:due_on</span>, <span class="st">:as</span> =&gt; <span class="st">&quot;Due Date&quot;</span>, <span class="st">:message</span> =&gt; <span class="st">&quot;has been rescheduled&quot;</span>, <span class="st">:format</span> =&gt; <span class="st">:pretty_print_date</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6">  <span class="co"># change the syntax of the message for working with dates, because it makes more sense that way</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"></a>
<a class="sourceLine" id="cb2-8" data-line-number="8">  <span class="co"># this method is used for formatting the due_on field when it changes</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9">  <span class="kw">def</span> pretty_print_date(value = <span class="dv">self</span>.due_on)</a>
<a class="sourceLine" id="cb2-10" data-line-number="10">    value.strftime(<span class="st">&quot;%d/%m/%Y&quot;</span>)</a>
<a class="sourceLine" id="cb2-11" data-line-number="11">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb2-12" data-line-number="12"><span class="kw">end</span></a></code></pre></div>
</body>
</html>
